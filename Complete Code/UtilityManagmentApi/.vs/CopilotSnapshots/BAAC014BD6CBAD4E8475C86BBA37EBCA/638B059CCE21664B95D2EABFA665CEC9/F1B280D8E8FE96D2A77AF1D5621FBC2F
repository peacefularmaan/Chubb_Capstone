using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;
using UtilityManagmentApi.Data;
using UtilityManagmentApi.DTOs.Auth;
using UtilityManagmentApi.DTOs.Common;
using UtilityManagmentApi.Entities;
using UtilityManagmentApi.Services.Interfaces;

namespace UtilityManagmentApi.Services.Implementations;

public class AuthService : IAuthService
{
    private readonly ApplicationDbContext _context;
    private readonly IConfiguration _configuration;

    public AuthService(ApplicationDbContext context, IConfiguration configuration)
    {
        _context = context;
        _configuration = configuration;
    }

    public async Task<ApiResponse<LoginResponseDto>> LoginAsync(LoginRequestDto request)
    {
        var user = await _context.Users
       .FirstOrDefaultAsync(u => u.Email.ToLower() == request.Email.ToLower());

        if (user == null || !BCrypt.Net.BCrypt.Verify(request.Password, user.PasswordHash))
  {
            return ApiResponse<LoginResponseDto>.ErrorResponse("Invalid email or password");
        }

        if (!user.IsActive)
        {
 return ApiResponse<LoginResponseDto>.ErrorResponse("User account is inactive");
        }

        var token = GenerateJwtToken(user);
     var refreshToken = GenerateRefreshToken();

        var response = new LoginResponseDto
        {
   Token = token,
   RefreshToken = refreshToken,
            Expiration = DateTime.UtcNow.AddHours(
          double.Parse(_configuration["JwtSettings:ExpirationHours"] ?? "24")),
   User = MapToUserDto(user)
        };

        return ApiResponse<LoginResponseDto>.SuccessResponse(response, "Login successful");
    }

    public async Task<ApiResponse<UserDto>> RegisterAsync(RegisterRequestDto request)
    {
        if (await _context.Users.AnyAsync(u => u.Email.ToLower() == request.Email.ToLower()))
        {
            return ApiResponse<UserDto>.ErrorResponse("Email already exists");
        }

 if (!Enum.TryParse<UserRole>(request.Role, true, out var role))
        {
            return ApiResponse<UserDto>.ErrorResponse("Invalid role specified");
        }

        var user = new User
        {
 FirstName = request.FirstName,
            LastName = request.LastName,
    Email = request.Email.ToLower(),
         PasswordHash = BCrypt.Net.BCrypt.HashPassword(request.Password),
  Phone = request.Phone,
            Role = role,
      IsActive = true,
    CreatedAt = DateTime.UtcNow
        };

        _context.Users.Add(user);
        await _context.SaveChangesAsync();

        return ApiResponse<UserDto>.SuccessResponse(MapToUserDto(user), "User registered successfully");
    }

    public async Task<ApiResponse<bool>> ChangePasswordAsync(int userId, ChangePasswordDto request)
    {
        var user = await _context.Users.FindAsync(userId);
        if (user == null)
    {
            return ApiResponse<bool>.ErrorResponse("User not found");
        }

      if (!BCrypt.Net.BCrypt.Verify(request.CurrentPassword, user.PasswordHash))
        {
            return ApiResponse<bool>.ErrorResponse("Current password is incorrect");
    }

   user.PasswordHash = BCrypt.Net.BCrypt.HashPassword(request.NewPassword);
        user.UpdatedAt = DateTime.UtcNow;

        await _context.SaveChangesAsync();

        return ApiResponse<bool>.SuccessResponse(true, "Password changed successfully");
    }

    public async Task<ApiResponse<UserDto>> GetUserByIdAsync(int userId)
    {
     var user = await _context.Users.FindAsync(userId);
        if (user == null)
        {
        return ApiResponse<UserDto>.ErrorResponse("User not found");
        }

        return ApiResponse<UserDto>.SuccessResponse(MapToUserDto(user));
    }

    public async Task<ApiResponse<List<UserDto>>> GetAllUsersAsync()
    {
        var users = await _context.Users
.OrderBy(u => u.LastName)
            .ThenBy(u => u.FirstName)
 .Select(u => MapToUserDto(u))
.ToListAsync();

     return ApiResponse<List<UserDto>>.SuccessResponse(users);
    }

    public async Task<ApiResponse<UserDto>> UpdateUserAsync(int userId, UpdateUserDto request)
    {
 var user = await _context.Users.FindAsync(userId);
if (user == null)
        {
     return ApiResponse<UserDto>.ErrorResponse("User not found");
        }

        if (!string.IsNullOrEmpty(request.FirstName))
            user.FirstName = request.FirstName;

        if (!string.IsNullOrEmpty(request.LastName))
         user.LastName = request.LastName;

        if (!string.IsNullOrEmpty(request.Phone))
            user.Phone = request.Phone;

        if (request.IsActive.HasValue)
            user.IsActive = request.IsActive.Value;

        user.UpdatedAt = DateTime.UtcNow;

        await _context.SaveChangesAsync();

        return ApiResponse<UserDto>.SuccessResponse(MapToUserDto(user), "User updated successfully");
    }

    public async Task<ApiResponse<bool>> DeleteUserAsync(int userId)
    {
        var user = await _context.Users.FindAsync(userId);
        if (user == null)
     {
            return ApiResponse<bool>.ErrorResponse("User not found");
 }

// Soft delete - just deactivate
        user.IsActive = false;
        user.UpdatedAt = DateTime.UtcNow;

      await _context.SaveChangesAsync();

   return ApiResponse<bool>.SuccessResponse(true, "User deleted successfully");
    }

    private string GenerateJwtToken(User user)
    {
        var key = new SymmetricSecurityKey(
            Encoding.UTF8.GetBytes(_configuration["JwtSettings:SecretKey"]!));
        var credentials = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

        var claims = new[]
        {
  new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
            new Claim(ClaimTypes.Email, user.Email),
    new Claim(ClaimTypes.Name, $"{user.FirstName} {user.LastName}"),
   new Claim(ClaimTypes.Role, user.Role.ToString()),
    new Claim("userId", user.Id.ToString())
        };

   var token = new JwtSecurityToken(
            issuer: _configuration["JwtSettings:Issuer"],
          audience: _configuration["JwtSettings:Audience"],
   claims: claims,
         expires: DateTime.UtcNow.AddHours(
          double.Parse(_configuration["JwtSettings:ExpirationHours"] ?? "24")),
signingCredentials: credentials
 );

        return new JwtSecurityTokenHandler().WriteToken(token);
  }

    private static string GenerateRefreshToken()
    {
      return Guid.NewGuid().ToString("N") + Guid.NewGuid().ToString("N");
    }

    private static UserDto MapToUserDto(User user)
    {
        return new UserDto
        {
            Id = user.Id,
          FirstName = user.FirstName,
         LastName = user.LastName,
Email = user.Email,
 Phone = user.Phone,
      Role = user.Role.ToString(),
     IsActive = user.IsActive,
            CreatedAt = user.CreatedAt
  };
    }
}
