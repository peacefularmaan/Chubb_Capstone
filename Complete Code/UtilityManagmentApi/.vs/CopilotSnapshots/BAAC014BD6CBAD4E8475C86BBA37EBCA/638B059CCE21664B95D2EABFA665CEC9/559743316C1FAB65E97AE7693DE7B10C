using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;
using UtilityManagmentApi.Data;
using UtilityManagmentApi.DTOs.Auth;
using UtilityManagmentApi.DTOs.Common;
using UtilityManagmentApi.Entities;
using UtilityManagmentApi.Services.Interfaces;

namespace UtilityManagmentApi.Services.Implementations;

public class AuthService : IAuthService
{
    private readonly ApplicationDbContext _context;
    private readonly IConfiguration _configuration;

    public AuthService(ApplicationDbContext context, IConfiguration configuration)
    {
        _context = context;
        _configuration = configuration;
    }

    public async Task<ApiResponse<LoginResponseDto>> LoginAsync(LoginRequestDto request)
    {
        var user = await _context.Users
   .Include(u => u.Consumer)
     .FirstOrDefaultAsync(u => u.Email.ToLower() == request.Email.ToLower());

    if (user == null || !BCrypt.Net.BCrypt.Verify(request.Password, user.PasswordHash))
        {
          return ApiResponse<LoginResponseDto>.ErrorResponse("Invalid email or password");
        }

 if (!user.IsActive)
      {
      return ApiResponse<LoginResponseDto>.ErrorResponse("User account is inactive");
    }

 var token = GenerateJwtToken(user);
    var refreshToken = GenerateRefreshToken();

        var response = new LoginResponseDto
        {
 Token = token,
    RefreshToken = refreshToken,
   Expiration = DateTime.UtcNow.AddHours(
     double.Parse(_configuration["JwtSettings:ExpirationHours"] ?? "24")),
        User = MapToUserDto(user)
        };

 return ApiResponse<LoginResponseDto>.SuccessResponse(response, "Login successful");
    }

    public async Task<ApiResponse<UserDto>> RegisterAsync(RegisterRequestDto request)
    {
        if (await _context.Users.AnyAsync(u => u.Email.ToLower() == request.Email.ToLower()))
        {
      return ApiResponse<UserDto>.ErrorResponse("Email already exists");
        }

        if (!Enum.TryParse<UserRole>(request.Role, true, out var role))
        {
            return ApiResponse<UserDto>.ErrorResponse("Invalid role specified");
     }

    var user = new User
        {
 FirstName = request.FirstName,
    LastName = request.LastName,
     Email = request.Email.ToLower(),
       PasswordHash = BCrypt.Net.BCrypt.HashPassword(request.Password),
        Phone = request.Phone,
     Role = role,
            IsActive = true,
         CreatedAt = DateTime.UtcNow
        };

        _context.Users.Add(user);
        await _context.SaveChangesAsync();

        return ApiResponse<UserDto>.SuccessResponse(MapToUserDto(user), "User registered successfully");
    }

    /// <summary>
    /// Public Consumer Registration - automatically assigns Consumer role and creates consumer profile
    /// </summary>
    public async Task<ApiResponse<LoginResponseDto>> RegisterConsumerAsync(ConsumerRegisterDto request)
  {
        if (await _context.Users.AnyAsync(u => u.Email.ToLower() == request.Email.ToLower()))
        {
   return ApiResponse<LoginResponseDto>.ErrorResponse("Email already exists");
  }

        using var transaction = await _context.Database.BeginTransactionAsync();

      try
        {
            // Create User with Consumer role
     var user = new User
            {
             FirstName = request.FirstName,
              LastName = request.LastName,
      Email = request.Email.ToLower(),
       PasswordHash = BCrypt.Net.BCrypt.HashPassword(request.Password),
           Phone = request.Phone,
       Role = UserRole.Consumer,  // Automatically assigned as Consumer
  IsActive = true,
         CreatedAt = DateTime.UtcNow
            };

        _context.Users.Add(user);
            await _context.SaveChangesAsync();

     // Generate Consumer Number
            var consumerNumber = await GenerateConsumerNumberAsync();

    // Create Consumer Profile
            var consumer = new Consumer
         {
         UserId = user.Id,
          ConsumerNumber = consumerNumber,
          Address = request.Address,
         City = request.City,
                State = request.State,
     PostalCode = request.PostalCode,
        RegistrationDate = DateTime.UtcNow,
 IsActive = true,
    CreatedAt = DateTime.UtcNow
            };

  _context.Consumers.Add(consumer);
            await _context.SaveChangesAsync();

          await transaction.CommitAsync();

            // Generate token and return login response
            var token = GenerateJwtToken(user);
          var refreshToken = GenerateRefreshToken();

            // Reload user with consumer
 user.Consumer = consumer;

            var response = new LoginResponseDto
   {
                Token = token,
   RefreshToken = refreshToken,
    Expiration = DateTime.UtcNow.AddHours(
    double.Parse(_configuration["JwtSettings:ExpirationHours"] ?? "24")),
    User = MapToUserDto(user)
            };

 return ApiResponse<LoginResponseDto>.SuccessResponse(response, "Registration successful. You are now logged in.");
   }
   catch (Exception)
    {
      await transaction.RollbackAsync();
 return ApiResponse<LoginResponseDto>.ErrorResponse("Registration failed. Please try again.");
        }
    }

    public async Task<ApiResponse<bool>> ChangePasswordAsync(int userId, ChangePasswordDto request)
    {
        var user = await _context.Users.FindAsync(userId);
    if (user == null)
      {
     return ApiResponse<bool>.ErrorResponse("User not found");
        }

        if (!BCrypt.Net.BCrypt.Verify(request.CurrentPassword, user.PasswordHash))
        {
  return ApiResponse<bool>.ErrorResponse("Current password is incorrect");
        }

  user.PasswordHash = BCrypt.Net.BCrypt.HashPassword(request.NewPassword);
  user.UpdatedAt = DateTime.UtcNow;

        await _context.SaveChangesAsync();

  return ApiResponse<bool>.SuccessResponse(true, "Password changed successfully");
    }

    public async Task<ApiResponse<UserDto>> GetUserByIdAsync(int userId)
    {
        var user = await _context.Users
        .Include(u => u.Consumer)
          .FirstOrDefaultAsync(u => u.Id == userId);

        if (user == null)
  {
 return ApiResponse<UserDto>.ErrorResponse("User not found");
  }

  return ApiResponse<UserDto>.SuccessResponse(MapToUserDto(user));
  }

    public async Task<ApiResponse<List<UserDto>>> GetAllUsersAsync()
    {
        var users = await _context.Users
     .Include(u => u.Consumer)
            .OrderBy(u => u.LastName)
            .ThenBy(u => u.FirstName)
            .ToListAsync();

        var userDtos = users.Select(u => MapToUserDto(u)).ToList();

        return ApiResponse<List<UserDto>>.SuccessResponse(userDtos);
  }

    public async Task<ApiResponse<UserDto>> UpdateUserAsync(int userId, UpdateUserDto request)
    {
        var user = await _context.Users.FindAsync(userId);
      if (user == null)
        {
            return ApiResponse<UserDto>.ErrorResponse("User not found");
     }

   if (!string.IsNullOrEmpty(request.FirstName))
 user.FirstName = request.FirstName;

        if (!string.IsNullOrEmpty(request.LastName))
          user.LastName = request.LastName;

        if (!string.IsNullOrEmpty(request.Phone))
user.Phone = request.Phone;

        if (request.IsActive.HasValue)
            user.IsActive = request.IsActive.Value;

        user.UpdatedAt = DateTime.UtcNow;

        await _context.SaveChangesAsync();

return ApiResponse<UserDto>.SuccessResponse(MapToUserDto(user), "User updated successfully");
    }

    public async Task<ApiResponse<bool>> DeleteUserAsync(int userId)
    {
        var user = await _context.Users.FindAsync(userId);
     if (user == null)
        {
  return ApiResponse<bool>.ErrorResponse("User not found");
     }

     // Soft delete - just deactivate
      user.IsActive = false;
    user.UpdatedAt = DateTime.UtcNow;

        await _context.SaveChangesAsync();

     return ApiResponse<bool>.SuccessResponse(true, "User deleted successfully");
    }

    private async Task<string> GenerateConsumerNumberAsync()
{
        var year = DateTime.UtcNow.Year.ToString().Substring(2);
      var lastConsumer = await _context.Consumers
            .Where(c => c.ConsumerNumber.StartsWith($"CON{year}"))
.OrderByDescending(c => c.ConsumerNumber)
            .FirstOrDefaultAsync();

 int nextNumber = 1;
        if (lastConsumer != null)
   {
        var lastNumberStr = lastConsumer.ConsumerNumber.Substring(5);
            if (int.TryParse(lastNumberStr, out int lastNumber))
            {
       nextNumber = lastNumber + 1;
      }
        }

        return $"CON{year}{nextNumber:D4}";
    }

    private string GenerateJwtToken(User user)
    {
        var key = new SymmetricSecurityKey(
            Encoding.UTF8.GetBytes(_configuration["JwtSettings:SecretKey"]!));
   var credentials = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

      var claims = new List<Claim>
        {
  new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
     new Claim(ClaimTypes.Email, user.Email),
        new Claim(ClaimTypes.Name, $"{user.FirstName} {user.LastName}"),
          new Claim(ClaimTypes.Role, user.Role.ToString()),
     new Claim("userId", user.Id.ToString())
        };

        // Add consumer number to claims if user is a consumer
        if (user.Consumer != null)
        {
    claims.Add(new Claim("consumerNumber", user.Consumer.ConsumerNumber));
            claims.Add(new Claim("consumerId", user.Consumer.Id.ToString()));
        }

var token = new JwtSecurityToken(
 issuer: _configuration["JwtSettings:Issuer"],
   audience: _configuration["JwtSettings:Audience"],
  claims: claims,
          expires: DateTime.UtcNow.AddHours(
          double.Parse(_configuration["JwtSettings:ExpirationHours"] ?? "24")),
     signingCredentials: credentials
        );

        return new JwtSecurityTokenHandler().WriteToken(token);
    }

    private static string GenerateRefreshToken()
    {
        return Guid.NewGuid().ToString("N") + Guid.NewGuid().ToString("N");
    }

    private static UserDto MapToUserDto(User user)
    {
        return new UserDto
     {
      Id = user.Id,
      FirstName = user.FirstName,
  LastName = user.LastName,
            Email = user.Email,
 Phone = user.Phone,
            Role = user.Role.ToString(),
 IsActive = user.IsActive,
      CreatedAt = user.CreatedAt,
            ConsumerNumber = user.Consumer?.ConsumerNumber
   };
    }
}
