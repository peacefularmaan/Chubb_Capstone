using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using UtilityManagmentApi.DTOs.Auth;
using UtilityManagmentApi.Services.Interfaces;
using System.Security.Claims;

namespace UtilityManagmentApi.Controllers;

[ApiController]
[Route("api/[controller]")]
public class AuthController : ControllerBase
{
    private readonly IAuthService _authService;

    public AuthController(IAuthService authService)
    {
        _authService = authService;
  }

    /// <summary>
    /// Login for all users
    /// </summary>
 [HttpPost("login")]
    public async Task<IActionResult> Login([FromBody] LoginRequestDto request)
    {
        var result = await _authService.LoginAsync(request);
        if (!result.Success)
      {
        return Unauthorized(result);
  }
    return Ok(result);
    }

    /// <summary>
    /// Public Consumer Registration - Anyone can register as a Consumer
    /// Automatically assigns Consumer role and creates consumer profile
    /// </summary>
    [HttpPost("register")]
  public async Task<IActionResult> RegisterConsumer([FromBody] ConsumerRegisterDto request)
    {
        var result = await _authService.RegisterConsumerAsync(request);
   if (!result.Success)
        {
         return BadRequest(result);
 }
        return Ok(result);
    }

 /// <summary>
    /// Admin-only: Register any user type (Admin, BillingOfficer, AccountOfficer)
    /// </summary>
    [HttpPost("register-staff")]
    [Authorize(Roles = "Admin")]
    public async Task<IActionResult> RegisterStaff([FromBody] RegisterRequestDto request)
    {
    var result = await _authService.RegisterAsync(request);
      if (!result.Success)
    {
          return BadRequest(result);
        }
return CreatedAtAction(nameof(GetUser), new { id = result.Data!.Id }, result);
    }

    /// <summary>
    /// Change password for logged-in user
    /// </summary>
    [HttpPost("change-password")]
    [Authorize]
    public async Task<IActionResult> ChangePassword([FromBody] ChangePasswordDto request)
{
 var userId = GetCurrentUserId();
  var result = await _authService.ChangePasswordAsync(userId, request);
        if (!result.Success)
  {
   return BadRequest(result);
        }
      return Ok(result);
    }

    /// <summary>
    /// Get current logged-in user details
    /// </summary>
    [HttpGet("me")]
    [Authorize]
    public async Task<IActionResult> GetCurrentUser()
    {
        var userId = GetCurrentUserId();
  var result = await _authService.GetUserByIdAsync(userId);
        if (!result.Success)
      {
     return NotFound(result);
  }
        return Ok(result);
    }

    /// <summary>
    /// Admin-only: Get all users
    /// </summary>
    [HttpGet("users")]
    [Authorize(Roles = "Admin")]
    public async Task<IActionResult> GetAllUsers()
{
        var result = await _authService.GetAllUsersAsync();
   return Ok(result);
    }

    /// <summary>
    /// Admin-only: Get user by ID
    /// </summary>
    [HttpGet("users/{id}")]
    [Authorize(Roles = "Admin")]
    public async Task<IActionResult> GetUser(int id)
    {
   var result = await _authService.GetUserByIdAsync(id);
    if (!result.Success)
        {
     return NotFound(result);
        }
     return Ok(result);
    }

    /// <summary>
    /// Admin-only: Update user
    /// </summary>
    [HttpPut("users/{id}")]
    [Authorize(Roles = "Admin")]
    public async Task<IActionResult> UpdateUser(int id, [FromBody] UpdateUserDto request)
 {
    var result = await _authService.UpdateUserAsync(id, request);
 if (!result.Success)
        {
   return BadRequest(result);
  }
return Ok(result);
    }

    /// <summary>
    /// Admin-only: Delete user
    /// </summary>
    [HttpDelete("users/{id}")]
    [Authorize(Roles = "Admin")]
    public async Task<IActionResult> DeleteUser(int id)
    {
  var result = await _authService.DeleteUserAsync(id);
  if (!result.Success)
  {
   return BadRequest(result);
  }
return Ok(result);
    }

    private int GetCurrentUserId()
    {
  var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier) ?? User.FindFirst("userId");
   return int.Parse(userIdClaim!.Value);
    }
}
