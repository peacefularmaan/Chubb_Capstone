using Microsoft.EntityFrameworkCore;
using UtilityManagmentApi.Entities;

namespace UtilityManagmentApi.Data;

public class ApplicationDbContext : DbContext
{
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options) : base(options)
    {
    }

    public DbSet<User> Users { get; set; }
    public DbSet<Consumer> Consumers { get; set; }
    public DbSet<UtilityType> UtilityTypes { get; set; }
    public DbSet<TariffPlan> TariffPlans { get; set; }
    public DbSet<Connection> Connections { get; set; }
    public DbSet<MeterReading> MeterReadings { get; set; }
    public DbSet<Bill> Bills { get; set; }
    public DbSet<Payment> Payments { get; set; }
    public DbSet<BillingCycle> BillingCycles { get; set; }
    public DbSet<Notification> Notifications { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
 base.OnModelCreating(modelBuilder);

        // User configuration
        modelBuilder.Entity<User>(entity =>
   {
     entity.HasIndex(e => e.Email).IsUnique();
            entity.Property(e => e.Role).HasConversion<string>();
        });

        // Consumer configuration
modelBuilder.Entity<Consumer>(entity =>
        {
            entity.HasIndex(e => e.ConsumerNumber).IsUnique();
     entity.HasOne(c => c.User)
    .WithOne(u => u.Consumer)
       .HasForeignKey<Consumer>(c => c.UserId)
                .OnDelete(DeleteBehavior.Restrict);
        });

   // UtilityType configuration
     modelBuilder.Entity<UtilityType>(entity =>
        {
            entity.HasIndex(e => e.Name).IsUnique();
   });

        // TariffPlan configuration
     modelBuilder.Entity<TariffPlan>(entity =>
 {
    entity.HasOne(t => t.UtilityType)
         .WithMany(u => u.TariffPlans)
           .HasForeignKey(t => t.UtilityTypeId)
     .OnDelete(DeleteBehavior.Restrict);
        });

        // Connection configuration
   modelBuilder.Entity<Connection>(entity =>
        {
     entity.HasIndex(e => e.MeterNumber).IsUnique();
            entity.HasIndex(e => e.ConnectionNumber).IsUnique();
   entity.Property(e => e.Status).HasConversion<string>();

            entity.HasOne(c => c.Consumer)
          .WithMany(co => co.Connections)
       .HasForeignKey(c => c.ConsumerId)
                .OnDelete(DeleteBehavior.Restrict);

            entity.HasOne(c => c.UtilityType)
  .WithMany(u => u.Connections)
        .HasForeignKey(c => c.UtilityTypeId)
    .OnDelete(DeleteBehavior.Restrict);

            entity.HasOne(c => c.TariffPlan)
         .WithMany(t => t.Connections)
         .HasForeignKey(c => c.TariffPlanId)
    .OnDelete(DeleteBehavior.Restrict);
        });

        // MeterReading configuration
        modelBuilder.Entity<MeterReading>(entity =>
        {
     entity.HasIndex(e => new { e.ConnectionId, e.BillingMonth, e.BillingYear }).IsUnique();

 entity.HasOne(m => m.Connection)
     .WithMany(c => c.MeterReadings)
                .HasForeignKey(m => m.ConnectionId)
           .OnDelete(DeleteBehavior.Restrict);

            entity.HasOne(m => m.ReadByUser)
      .WithMany()
              .HasForeignKey(m => m.ReadByUserId)
      .OnDelete(DeleteBehavior.SetNull);
        });

        // Bill configuration
        modelBuilder.Entity<Bill>(entity =>
        {
          entity.HasIndex(e => e.BillNumber).IsUnique();
 entity.HasIndex(e => new { e.ConnectionId, e.BillingMonth, e.BillingYear }).IsUnique();
         entity.Property(e => e.Status).HasConversion<string>();

            entity.HasOne(b => b.Connection)
     .WithMany(c => c.Bills)
        .HasForeignKey(b => b.ConnectionId)
   .OnDelete(DeleteBehavior.Restrict);

            entity.HasOne(b => b.MeterReading)
             .WithOne(m => m.Bill)
    .HasForeignKey<Bill>(b => b.MeterReadingId)
         .OnDelete(DeleteBehavior.SetNull);

            entity.HasOne(b => b.GeneratedByUser)
             .WithMany()
        .HasForeignKey(b => b.GeneratedByUserId)
          .OnDelete(DeleteBehavior.SetNull);
        });

  // Payment configuration
        modelBuilder.Entity<Payment>(entity =>
        {
            entity.HasIndex(e => e.PaymentNumber).IsUnique();
          entity.Property(e => e.PaymentMethod).HasConversion<string>();
entity.Property(e => e.Status).HasConversion<string>();

            entity.HasOne(p => p.Bill)
    .WithMany(b => b.Payments)
     .HasForeignKey(p => p.BillId)
                .OnDelete(DeleteBehavior.Restrict);

entity.HasOne(p => p.ReceivedByUser)
      .WithMany()
        .HasForeignKey(p => p.ReceivedByUserId)
         .OnDelete(DeleteBehavior.SetNull);
 });

   // BillingCycle configuration
    modelBuilder.Entity<BillingCycle>(entity =>
     {
            entity.HasIndex(e => new { e.Month, e.Year }).IsUnique();
 entity.Property(e => e.Status).HasConversion<string>();
     });

        // Notification configuration
        modelBuilder.Entity<Notification>(entity =>
     {
            entity.Property(e => e.Type).HasConversion<string>();

         entity.HasOne(n => n.User)
     .WithMany()
  .HasForeignKey(n => n.UserId)
                .OnDelete(DeleteBehavior.Cascade);
      });

        // Seed initial data
        SeedData(modelBuilder);
    }

    private void SeedData(ModelBuilder modelBuilder)
    {
        // Seed Utility Types
     modelBuilder.Entity<UtilityType>().HasData(
            new UtilityType { Id = 1, Name = "Electricity", Description = "Electric power supply", UnitOfMeasurement = "kWh", IsActive = true, CreatedAt = DateTime.UtcNow },
            new UtilityType { Id = 2, Name = "Water", Description = "Water supply", UnitOfMeasurement = "Gallons", IsActive = true, CreatedAt = DateTime.UtcNow },
  new UtilityType { Id = 3, Name = "Gas", Description = "Natural gas supply", UnitOfMeasurement = "Cubic Feet", IsActive = true, CreatedAt = DateTime.UtcNow },
            new UtilityType { Id = 4, Name = "Internet", Description = "Internet services", UnitOfMeasurement = "GB", IsActive = true, CreatedAt = DateTime.UtcNow }
      );

        // Seed Admin User (password: Admin@123)
        modelBuilder.Entity<User>().HasData(
    new User
         {
                Id = 1,
    FirstName = "System",
    LastName = "Administrator",
Email = "admin@utilitybilling.com",
            PasswordHash = BCrypt.Net.BCrypt.HashPassword("Admin@123"),
       Phone = "1234567890",
     Role = UserRole.Admin,
          IsActive = true,
       CreatedAt = DateTime.UtcNow
            }
        );

        // Seed sample Tariff Plans
        modelBuilder.Entity<TariffPlan>().HasData(
  new TariffPlan
    {
          Id = 1,
         Name = "Residential Electricity - Standard",
      Description = "Standard residential electricity tariff",
                UtilityTypeId = 1,
           RatePerUnit = 0.12m,
  FixedCharges = 10.00m,
         TaxPercentage = 8.00m,
      LatePaymentPenalty = 25.00m,
        IsActive = true,
   EffectiveFrom = new DateTime(2024, 1, 1),
  CreatedAt = DateTime.UtcNow
      },
     new TariffPlan
       {
       Id = 2,
    Name = "Commercial Electricity - Standard",
  Description = "Standard commercial electricity tariff",
  UtilityTypeId = 1,
            RatePerUnit = 0.15m,
       FixedCharges = 25.00m,
     TaxPercentage = 10.00m,
        LatePaymentPenalty = 50.00m,
             IsActive = true,
         EffectiveFrom = new DateTime(2024, 1, 1),
     CreatedAt = DateTime.UtcNow
         },
            new TariffPlan
      {
     Id = 3,
   Name = "Residential Water - Standard",
     Description = "Standard residential water tariff",
      UtilityTypeId = 2,
          RatePerUnit = 0.005m,
           FixedCharges = 5.00m,
  TaxPercentage = 5.00m,
                LatePaymentPenalty = 15.00m,
              IsActive = true,
    EffectiveFrom = new DateTime(2024, 1, 1),
     CreatedAt = DateTime.UtcNow
            },
         new TariffPlan
          {
    Id = 4,
        Name = "Residential Gas - Standard",
       Description = "Standard residential gas tariff",
                UtilityTypeId = 3,
   RatePerUnit = 0.02m,
    FixedCharges = 8.00m,
    TaxPercentage = 6.00m,
     LatePaymentPenalty = 20.00m,
            IsActive = true,
      EffectiveFrom = new DateTime(2024, 1, 1),
         CreatedAt = DateTime.UtcNow
            },
            new TariffPlan
   {
    Id = 5,
       Name = "Internet - Basic Plan",
    Description = "Basic internet plan - 100GB",
  UtilityTypeId = 4,
    RatePerUnit = 0.50m,
   FixedCharges = 29.99m,
    TaxPercentage = 8.00m,
        LatePaymentPenalty = 10.00m,
                IsActive = true,
 EffectiveFrom = new DateTime(2024, 1, 1),
                CreatedAt = DateTime.UtcNow
   }
      );
    }
}
