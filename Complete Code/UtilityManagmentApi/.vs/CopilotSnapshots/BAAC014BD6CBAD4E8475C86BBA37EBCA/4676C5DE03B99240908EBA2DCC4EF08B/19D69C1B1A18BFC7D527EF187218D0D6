using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using UtilityManagmentApi.DTOs.Bill;
using UtilityManagmentApi.DTOs.Common;
using UtilityManagmentApi.Services.Interfaces;
using System.Security.Claims;

namespace UtilityManagmentApi.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize]
public class BillsController : ControllerBase
{
    private readonly IBillService _billService;
    private readonly IConsumerService _consumerService;

    public BillsController(IBillService billService, IConsumerService consumerService)
    {
        _billService = billService;
        _consumerService = consumerService;
    }

    /// <summary>
    /// Get All Bills - BillingOfficer (generates bills) and AccountOfficer (tracks payments)
    /// </summary>
    [HttpGet]
    [Authorize(Roles = "BillingOfficer,AccountOfficer")]
    public async Task<IActionResult> GetAll(
    [FromQuery] PaginationParams paginationParams,
      [FromQuery] string? status = null,
        [FromQuery] int? billingMonth = null,
        [FromQuery] int? billingYear = null)
    {
        var result = await _billService.GetAllAsync(paginationParams, status, billingMonth, billingYear);
      return Ok(result);
    }

    /// <summary>
    /// Get Bill by ID
    /// </summary>
    [HttpGet("{id}")]
    [Authorize(Roles = "BillingOfficer,AccountOfficer,Consumer")]
    public async Task<IActionResult> GetById(int id)
    {
      var result = await _billService.GetByIdAsync(id);
        if (!result.Success)
        {
  return NotFound(result);
   }

        // Consumer can only view their own bills
 if (User.IsInRole("Consumer"))
        {
         var userId = GetCurrentUserId();
    var consumer = await _consumerService.GetByUserIdAsync(userId);
  if (!consumer.Success || result.Data!.ConsumerNumber != consumer.Data!.ConsumerNumber)
  {
          return Forbid();
      }
        }

        return Ok(result);
    }

 /// <summary>
    /// Get Bill by Number - BillingOfficer and AccountOfficer only
    /// </summary>
    [HttpGet("number/{billNumber}")]
    [Authorize(Roles = "BillingOfficer,AccountOfficer")]
    public async Task<IActionResult> GetByBillNumber(string billNumber)
    {
        var result = await _billService.GetByBillNumberAsync(billNumber);
        if (!result.Success)
        {
            return NotFound(result);
        }
     return Ok(result);
    }

  /// <summary>
    /// Get Bills by Connection - BillingOfficer, AccountOfficer, Consumer (own)
    /// </summary>
    [HttpGet("connection/{connectionId}")]
    [Authorize(Roles = "BillingOfficer,AccountOfficer,Consumer")]
    public async Task<IActionResult> GetByConnectionId(int connectionId)
    {
        var result = await _billService.GetByConnectionIdAsync(connectionId);
        return Ok(result);
    }

    /// <summary>
    /// Get Bills by Consumer - BillingOfficer, AccountOfficer, Consumer (own)
    /// </summary>
    [HttpGet("consumer/{consumerId}")]
    [Authorize(Roles = "BillingOfficer,AccountOfficer,Consumer")]
    public async Task<IActionResult> GetByConsumerId(int consumerId)
    {
   // Consumer can only view their own bills
        if (User.IsInRole("Consumer"))
    {
          var userId = GetCurrentUserId();
     var consumer = await _consumerService.GetByUserIdAsync(userId);
       if (!consumer.Success || consumer.Data!.Id != consumerId)
            {
                return Forbid();
         }
        }

   var result = await _billService.GetByConsumerIdAsync(consumerId);
   return Ok(result);
}

    /// <summary>
    /// Get My Bills - Consumer only (view their own bills)
  /// </summary>
    [HttpGet("my-bills")]
    [Authorize(Roles = "Consumer")]
    public async Task<IActionResult> GetMyBills()
    {
        var userId = GetCurrentUserId();
     var consumer = await _consumerService.GetByUserIdAsync(userId);
   if (!consumer.Success)
        {
  return NotFound(consumer);
        }

  var result = await _billService.GetByConsumerIdAsync(consumer.Data!.Id);
        return Ok(result);
    }

    /// <summary>
    /// Get Overdue Bills - AccountOfficer only (tracks outstanding balances)
    /// </summary>
    [HttpGet("overdue")]
    [Authorize(Roles = "AccountOfficer")]
    public async Task<IActionResult> GetOverdueBills()
    {
        var result = await _billService.GetOverdueBillsAsync();
        return Ok(result);
    }

    /// <summary>
    /// Get Bill Summary - BillingOfficer (billing work) and AccountOfficer (payment work)
    /// </summary>
    [HttpGet("summary")]
    [Authorize(Roles = "BillingOfficer,AccountOfficer")]
    public async Task<IActionResult> GetSummary([FromQuery] int? billingMonth = null, [FromQuery] int? billingYear = null)
    {
        var result = await _billService.GetSummaryAsync(billingMonth, billingYear);
     return Ok(result);
    }

    /// <summary>
    /// Generate Bill - BillingOfficer only (enters meter readings and generates bills)
    /// </summary>
    [HttpPost("generate")]
    [Authorize(Roles = "BillingOfficer")]
  public async Task<IActionResult> GenerateBill([FromBody] GenerateBillDto dto)
    {
  var userId = GetCurrentUserId();
  var result = await _billService.GenerateBillAsync(dto, userId);
        if (!result.Success)
        {
            return BadRequest(result);
     }
        return CreatedAtAction(nameof(GetById), new { id = result.Data!.Id }, result);
    }

    /// <summary>
    /// Generate Bulk Bills - BillingOfficer only
    /// </summary>
    [HttpPost("generate-bulk")]
 [Authorize(Roles = "BillingOfficer")]
    public async Task<IActionResult> GenerateBulkBills([FromBody] GenerateBulkBillsDto dto)
    {
    var userId = GetCurrentUserId();
        var result = await _billService.GenerateBulkBillsAsync(dto, userId);
    if (!result.Success)
        {
    return BadRequest(result);
        }
 return Ok(result);
    }

    /// <summary>
    /// Update Bill Status - BillingOfficer only
    /// </summary>
    [HttpPut("{id}/status")]
    [Authorize(Roles = "BillingOfficer")]
    public async Task<IActionResult> UpdateStatus(int id, [FromBody] UpdateBillStatusDto dto)
    {
        var result = await _billService.UpdateStatusAsync(id, dto);
   if (!result.Success)
        {
            return BadRequest(result);
      }
        return Ok(result);
    }

    /// <summary>
    /// Delete Bill - BillingOfficer only (their work)
    /// </summary>
    [HttpDelete("{id}")]
    [Authorize(Roles = "BillingOfficer")]
    public async Task<IActionResult> Delete(int id)
    {
        var result = await _billService.DeleteAsync(id);
     if (!result.Success)
      {
 return BadRequest(result);
        }
        return Ok(result);
    }

  /// <summary>
    /// Update Overdue Bills - AccountOfficer only (tracks outstanding balances)
    /// </summary>
    [HttpPost("update-overdue")]
    [Authorize(Roles = "AccountOfficer")]
    public async Task<IActionResult> UpdateOverdueBills()
 {
        await _billService.UpdateOverdueBillsAsync();
        return Ok(new { message = "Overdue bills updated successfully" });
 }

    private int GetCurrentUserId()
    {
        var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier) ?? User.FindFirst("userId");
        return int.Parse(userIdClaim!.Value);
    }
}
