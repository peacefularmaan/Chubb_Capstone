using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using UtilityManagmentApi.Services.Interfaces;

namespace UtilityManagmentApi.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize]
public class ReportsController : ControllerBase
{
    private readonly IReportService _reportService;

    public ReportsController(IReportService reportService)
    {
        _reportService = reportService;
    }

    /// <summary>
    /// Dashboard - Each role sees their relevant dashboard data
    /// </summary>
    [HttpGet("dashboard")]
    public async Task<IActionResult> GetDashboardSummary()
    {
        var result = await _reportService.GetDashboardSummaryAsync();
        return Ok(result);
  }

    /// <summary>
    /// Monthly Revenue Report - AccountOfficer only (tracks payments)
    /// </summary>
    [HttpGet("revenue/monthly")]
    [Authorize(Roles = "AccountOfficer")]
    public async Task<IActionResult> GetMonthlyRevenueReport([FromQuery] int month, [FromQuery] int year)
    {
        var result = await _reportService.GetMonthlyRevenueReportAsync(month, year);
 return Ok(result);
    }

/// <summary>
    /// Yearly Revenue Report - AccountOfficer only (tracks payments)
    /// </summary>
    [HttpGet("revenue/yearly")]
    [Authorize(Roles = "AccountOfficer")]
    public async Task<IActionResult> GetYearlyRevenueReport([FromQuery] int year)
    {
        var result = await _reportService.GetYearlyRevenueReportAsync(year);
    return Ok(result);
    }

    /// <summary>
    /// Outstanding Dues Report - AccountOfficer only (tracks outstanding balances)
    /// </summary>
    [HttpGet("outstanding-dues")]
    [Authorize(Roles = "AccountOfficer")]
    public async Task<IActionResult> GetOutstandingDuesReport()
    {
        var result = await _reportService.GetOutstandingDuesReportAsync();
        return Ok(result);
  }

    /// <summary>
    /// Consumption Report - BillingOfficer only (enters meter readings)
    /// </summary>
    [HttpGet("consumption")]
    [Authorize(Roles = "BillingOfficer")]
    public async Task<IActionResult> GetConsumptionReport([FromQuery] int month, [FromQuery] int year)
 {
        var result = await _reportService.GetConsumptionReportAsync(month, year);
        return Ok(result);
    }

    /// <summary>
    /// Consumer Billing Summary - AccountOfficer only (tracks payments per consumer)
    /// </summary>
    [HttpGet("consumer-billing/{consumerId}")]
    [Authorize(Roles = "AccountOfficer")]
  public async Task<IActionResult> GetConsumerBillingSummary(int consumerId)
    {
        var result = await _reportService.GetConsumerBillingSummaryAsync(consumerId);
     if (!result.Success)
        {
          return NotFound(result);
        }
        return Ok(result);
    }

    /// <summary>
    /// Collection Report - AccountOfficer only (tracks payment collections)
    /// </summary>
    [HttpGet("collection")]
    [Authorize(Roles = "AccountOfficer")]
    public async Task<IActionResult> GetCollectionReport([FromQuery] DateTime fromDate, [FromQuery] DateTime toDate)
    {
        var result = await _reportService.GetCollectionReportAsync(fromDate, toDate);
        return Ok(result);
    }
}
