using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using UtilityManagmentApi.DTOs.Common;
using UtilityManagmentApi.DTOs.Consumer;
using UtilityManagmentApi.Services.Interfaces;
using System.Security.Claims;

namespace UtilityManagmentApi.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize]
public class ConsumersController : ControllerBase
{
    private readonly IConsumerService _consumerService;

    public ConsumersController(IConsumerService consumerService)
    {
        _consumerService = consumerService;
    }

    /// <summary>
    /// Admin views all the consumers
    /// </summary>
    [HttpGet]
    [Authorize(Roles = "Admin")]
    public async Task<IActionResult> GetAll([FromQuery] PaginationParams paginationParams, [FromQuery] bool? isActive = null)
    {
        var result = await _consumerService.GetAllAsync(paginationParams, isActive);
        return Ok(result);
    }

    /// <summary>
    /// Get Consumer by ID
    /// </summary>
    [HttpGet("{id}")]
    [Authorize(Roles = "Admin,Consumer")]
    public async Task<IActionResult> GetById(int id)
    {
        var result = await _consumerService.GetByIdAsync(id);
        if (!result.Success)
        {
            return NotFound(result);
        }
        return Ok(result);
    }

    /// <summary>
    /// Get My Profile - Consumer only (view own details)
    /// In the My Account section of Consumer Dashboard, the consumer can see al his details(get) and edit them (put)
    /// </summary>
    [HttpGet("my-profile")]
    [Authorize(Roles = "Consumer")]
    public async Task<IActionResult> GetMyProfile()
    {
        var userId = GetCurrentUserId();
        var result = await _consumerService.GetByUserIdAsync(userId);
        if (!result.Success)
        {
            return NotFound(result);
        }
        return Ok(result);
    }

    /// <summary>
    /// Update My Profile - Consumer only (update own details)
    /// </summary>
    [HttpPut("my-profile")]
    [Authorize(Roles = "Consumer")]
    public async Task<IActionResult> UpdateMyProfile([FromBody] UpdateConsumerDto dto)
    {
        var userId = GetCurrentUserId();
        var consumer = await _consumerService.GetByUserIdAsync(userId);
        if (!consumer.Success || consumer.Data == null)
        {
            return NotFound(consumer);
        }

        var result = await _consumerService.UpdateAsync(consumer.Data.Id, dto);
        if (!result.Success)
        {
            return BadRequest(result);
        }
        return Ok(result);
    }

    /// <summary>
    /// Create Consumer - Admin only (manages users)
    /// </summary>
    [HttpPost]
    [Authorize(Roles = "Admin")]
    public async Task<IActionResult> Create([FromBody] CreateConsumerDto dto)
    {
        var result = await _consumerService.CreateAsync(dto);
        if (!result.Success)
        {
            return BadRequest(result);
        }
        return CreatedAtAction(nameof(GetById), new { id = result.Data!.Id }, result);
    }

    /// <summary>
    /// Update Consumer - Admin only (manages users)
    /// happens in User Management Section
    /// </summary>
    [HttpPut("{id}")]
    [Authorize(Roles = "Admin")]
    public async Task<IActionResult> Update(int id, [FromBody] UpdateConsumerDto dto)
    {
        var result = await _consumerService.UpdateAsync(id, dto);
        if (!result.Success)
        {
            return BadRequest(result);
        }
        return Ok(result);
    }

    private int GetCurrentUserId()
    {
        var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier) ?? User.FindFirst("userId");
        return int.Parse(userIdClaim!.Value);
    }
}